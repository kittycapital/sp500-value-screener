<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë¹„íŠ¸ì½”ì¸ ETF ìê¸ˆ íë¦„ ëŒ€ì‹œë³´ë“œ</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg-primary: #0a0a0f;
  --bg-card: #12121a;
  --bg-card-hover: #181824;
  --bg-elevated: #1a1a28;
  --border: #1e1e30;
  --border-glow: #2a2a45;
  --text-primary: #e8e8f0;
  --text-secondary: #8888a8;
  --text-muted: #555570;
  --green: #00d68f;
  --green-dim: #00d68f33;
  --green-bg: #00d68f15;
  --red: #ff3d71;
  --red-dim: #ff3d7133;
  --red-bg: #ff3d7115;
  --blue: #3366ff;
  --blue-dim: #3366ff33;
  --orange: #ffaa00;
  --purple: #9966ff;
  --cyan: #00cfff;
  --accent: #00d68f;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: var(--bg-primary);
  color: var(--text-primary);
  font-family: 'Noto Sans KR', sans-serif;
  line-height: 1.6;
  min-height: 100vh;
}

.mono { font-family: 'JetBrains Mono', monospace; }

/* â”€â”€â”€ Header â”€â”€â”€ */
.header {
  padding: 28px 32px 20px;
  border-bottom: 1px solid var(--border);
  background: linear-gradient(180deg, #0e0e18 0%, var(--bg-primary) 100%);
}

.header-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 16px;
}

.header h1 {
  font-size: 22px;
  font-weight: 700;
  letter-spacing: -0.5px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.header h1 .btc-icon {
  width: 28px;
  height: 28px;
  background: var(--orange);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  font-weight: 700;
  color: #000;
}

.header-meta {
  display: flex;
  align-items: center;
  gap: 20px;
  font-size: 12px;
  color: var(--text-muted);
}

.header-meta .status {
  display: flex;
  align-items: center;
  gap: 6px;
}

.header-meta .dot {
  width: 6px;
  height: 6px;
  background: var(--green);
  border-radius: 50%;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

.period-selector {
  display: flex;
  gap: 4px;
  margin-top: 16px;
}

.period-btn {
  padding: 6px 14px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: transparent;
  color: var(--text-secondary);
  font-size: 12px;
  font-family: 'JetBrains Mono', monospace;
  cursor: pointer;
  transition: all 0.2s;
}

.period-btn:hover { border-color: var(--border-glow); color: var(--text-primary); }
.period-btn.active {
  background: var(--accent);
  color: #000;
  border-color: var(--accent);
  font-weight: 600;
}

/* â”€â”€â”€ Dashboard Grid â”€â”€â”€ */
.dashboard {
  max-width: 1400px;
  margin: 0 auto;
  padding: 24px;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

/* â”€â”€â”€ Summary Cards â”€â”€â”€ */
.summary-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 12px;
}

.card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 18px 20px;
  transition: all 0.3s;
}

.card:hover {
  background: var(--bg-card-hover);
  border-color: var(--border-glow);
}

.card-label {
  font-size: 11px;
  font-weight: 500;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}

.card-value {
  font-family: 'JetBrains Mono', monospace;
  font-size: 24px;
  font-weight: 600;
  letter-spacing: -0.5px;
}

.card-value.positive { color: var(--green); }
.card-value.negative { color: var(--red); }
.card-value.neutral { color: var(--text-primary); }

.card-sub {
  font-size: 11px;
  color: var(--text-muted);
  margin-top: 4px;
}

/* â”€â”€â”€ Chart Sections â”€â”€â”€ */
.chart-section {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 24px;
}

.chart-section:hover {
  border-color: var(--border-glow);
}

.chart-title {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.chart-subtitle {
  font-size: 11px;
  color: var(--text-muted);
  margin-bottom: 20px;
}

.chart-container {
  position: relative;
  width: 100%;
  height: 320px;
}

.chart-container.tall { height: 400px; }

/* â”€â”€â”€ Two Column Layout â”€â”€â”€ */
.two-col {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

/* â”€â”€â”€ ETF Table â”€â”€â”€ */
.etf-table-wrap {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

.etf-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

.etf-table th {
  text-align: left;
  padding: 10px 12px;
  font-size: 11px;
  font-weight: 500;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
}

.etf-table td {
  padding: 10px 12px;
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
}

.etf-table tr:last-child td { border-bottom: none; }

.etf-table tr:hover td { background: var(--bg-elevated); }

.etf-table .ticker {
  font-family: 'JetBrains Mono', monospace;
  font-weight: 600;
  font-size: 13px;
}

.etf-table .issuer { color: var(--text-secondary); font-size: 11px; }

.etf-table .flow-value {
  font-family: 'JetBrains Mono', monospace;
  font-weight: 500;
}

.etf-table .flow-value.pos { color: var(--green); }
.etf-table .flow-value.neg { color: var(--red); }
.etf-table .flow-value.zero { color: var(--text-muted); }

.flow-bar-cell {
  width: 120px;
}

.flow-bar-wrap {
  width: 100%;
  height: 6px;
  background: var(--bg-primary);
  border-radius: 3px;
  position: relative;
  overflow: hidden;
}

.flow-bar {
  height: 100%;
  border-radius: 3px;
  transition: width 0.5s ease;
}

.flow-bar.pos { background: var(--green); }
.flow-bar.neg { background: var(--red); }

/* â”€â”€â”€ Daily Table (Last 10 days) â”€â”€â”€ */
.daily-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
}

.daily-table th {
  padding: 8px 10px;
  font-size: 10px;
  font-weight: 500;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-bottom: 1px solid var(--border);
  text-align: right;
  white-space: nowrap;
}

.daily-table th:first-child { text-align: left; }

.daily-table td {
  padding: 8px 10px;
  border-bottom: 1px solid var(--border);
  text-align: right;
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  white-space: nowrap;
}

.daily-table td:first-child {
  text-align: left;
  color: var(--text-secondary);
  font-family: 'Noto Sans KR', sans-serif;
}

.daily-table tr:hover td { background: var(--bg-elevated); }

.daily-table .pos { color: var(--green); }
.daily-table .neg { color: var(--red); }
.daily-table .zero { color: var(--text-muted); }
.daily-table .total-col { font-weight: 600; }

/* â”€â”€â”€ Footer â”€â”€â”€ */
.footer {
  text-align: center;
  padding: 24px;
  font-size: 11px;
  color: var(--text-muted);
  border-top: 1px solid var(--border);
}

.footer a { color: var(--text-secondary); text-decoration: none; }
.footer a:hover { color: var(--text-primary); }

/* â”€â”€â”€ Responsive â”€â”€â”€ */
@media (max-width: 900px) {
  .two-col { grid-template-columns: 1fr; }
  .header { padding: 20px 16px 16px; }
  .dashboard { padding: 16px; }
  .chart-container { height: 260px; }
  .chart-container.tall { height: 300px; }
  .summary-grid { grid-template-columns: repeat(2, 1fr); }
}

@media (max-width: 500px) {
  .summary-grid { grid-template-columns: 1fr; }
  .card-value { font-size: 20px; }
  .header h1 { font-size: 18px; }
}

/* â”€â”€â”€ Loading â”€â”€â”€ */
.loading {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 200px;
  color: var(--text-muted);
  font-size: 14px;
}

.spinner {
  width: 20px;
  height: 20px;
  border: 2px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-right: 10px;
}

@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<div class="header">
  <div class="header-top">
    <h1>
      <span class="btc-icon">â‚¿</span>
      ë¹„íŠ¸ì½”ì¸ ETF ìê¸ˆ íë¦„
    </h1>
    <div class="header-meta">
      <span class="status"><span class="dot"></span> ë§¤ì¼ ìë™ ì—…ë°ì´íŠ¸</span>
      <span id="lastUpdated">-</span>
    </div>
  </div>
  <div class="period-selector">
    <button class="period-btn" data-period="14">2ì£¼</button>
    <button class="period-btn" data-period="30">1ê°œì›”</button>
    <button class="period-btn active" data-period="60">2ê°œì›”</button>
    <button class="period-btn" data-period="0">ì „ì²´</button>
  </div>
</div>

<div class="dashboard">
  <!-- Summary Cards -->
  <div class="summary-grid" id="summaryCards">
    <div class="loading"><div class="spinner"></div>ë°ì´í„° ë¡œë”© ì¤‘...</div>
  </div>

  <!-- Daily Net Flow Bar Chart -->
  <div class="chart-section">
    <div class="chart-title">ğŸ“Š ì¼ë³„ ìˆœìœ ì…/ìœ ì¶œ</div>
    <div class="chart-subtitle">ë¯¸êµ­ ë¹„íŠ¸ì½”ì¸ í˜„ë¬¼ ETF ì „ì²´ Â· ë‹¨ìœ„: ë°±ë§Œ ë‹¬ëŸ¬ (US$M)</div>
    <div class="chart-container tall">
      <canvas id="dailyFlowChart"></canvas>
    </div>
  </div>

  <!-- Cumulative + Top ETF Breakdown -->
  <div class="two-col">
    <div class="chart-section">
      <div class="chart-title">ğŸ“ˆ ëˆ„ì  ìˆœìœ ì…</div>
      <div class="chart-subtitle">ê¸°ê°„ ë‚´ ëˆ„ì  í•©ê³„ (US$M)</div>
      <div class="chart-container">
        <canvas id="cumulativeChart"></canvas>
      </div>
    </div>

    <div class="chart-section">
      <div class="chart-title">ğŸ¢ ETFë³„ ì ìœ ìœ¨</div>
      <div class="chart-subtitle">ê¸°ê°„ ë‚´ ì´ ìœ ì…ëŸ‰ ê¸°ì¤€</div>
      <div class="chart-container">
        <canvas id="etfShareChart"></canvas>
      </div>
    </div>
  </div>

  <!-- ETF Breakdown Stacked Bar -->
  <div class="chart-section">
    <div class="chart-title">ğŸ” ì£¼ìš” ETFë³„ ì¼ë³„ íë¦„</div>
    <div class="chart-subtitle">IBIT Â· FBTC Â· GBTC Â· ARKB Â· BITB ìƒìœ„ 5ê°œ ETF</div>
    <div class="chart-container tall">
      <canvas id="stackedChart"></canvas>
    </div>
  </div>

  <!-- ETF Summary Table + Recent Daily -->
  <div class="two-col">
    <div class="chart-section">
      <div class="chart-title">ğŸ“‹ ETFë³„ ê¸°ê°„ í•©ê³„</div>
      <div class="chart-subtitle">ì„ íƒ ê¸°ê°„ ë‚´ ETFë³„ ìˆœìœ ì…/ìœ ì¶œ í•©ê³„</div>
      <div class="etf-table-wrap" id="etfTableWrap"></div>
    </div>

    <div class="chart-section">
      <div class="chart-title">ğŸ“… ìµœê·¼ 10ì¼ ìƒì„¸</div>
      <div class="chart-subtitle">ETFë³„ ì¼ë³„ ìˆœìœ ì…/ìœ ì¶œ (US$M)</div>
      <div class="etf-table-wrap" id="dailyTableWrap" style="max-height: 500px; overflow-y: auto;"></div>
    </div>
  </div>

  <!-- Weekly Summary -->
  <div class="chart-section">
    <div class="chart-title">ğŸ“† ì£¼ê°„ íë¦„ ìš”ì•½</div>
    <div class="chart-subtitle">ì£¼ì°¨ë³„ ìˆœìœ ì…/ìœ ì¶œ í•©ê³„ (US$M)</div>
    <div class="chart-container">
      <canvas id="weeklyChart"></canvas>
    </div>
  </div>
</div>

<div class="footer">
  ë°ì´í„° ì¶œì²˜: <a href="https://bitbo.io/treasuries/etf-flows/" target="_blank">bitbo.io</a> Â·
  GitHub Actionsë¡œ ë§¤ì¼ ìë™ ì—…ë°ì´íŠ¸ Â·
  íˆ¬ì ì¡°ì–¸ì´ ì•„ë‹™ë‹ˆë‹¤
</div>

<script>
// â”€â”€â”€ Chart.js availability check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if (typeof Chart === 'undefined') {
  document.getElementById('summaryCards').innerHTML =
    '<div class="loading" style="color: #ff3d71;">Chart.js ë¡œë”© ì‹¤íŒ¨ â€” í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”</div>';
  throw new Error('Chart.js failed to load');
}

// â”€â”€â”€ Chart.js Global Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Chart.defaults.color = '#8888a8';
Chart.defaults.borderColor = '#1e1e30';
Chart.defaults.font.family = "'JetBrains Mono', 'Noto Sans KR', monospace";
Chart.defaults.font.size = 11;
Chart.defaults.plugins.legend.labels.boxWidth = 12;
Chart.defaults.plugins.legend.labels.padding = 16;

const COLORS = {
  IBIT: '#3366ff',
  FBTC: '#00d68f',
  GBTC: '#ff3d71',
  ARKB: '#ffaa00',
  BITB: '#9966ff',
  BTC: '#00cfff',
  HODL: '#ff6b35',
  BTCO: '#44aaee',
  BRRR: '#ee44aa',
  EZBC: '#66ee44',
  BTCW: '#eeee44',
  DEFI: '#aa66ee',
};

const TOP_ETFS = ['IBIT', 'FBTC', 'GBTC', 'ARKB', 'BITB'];

let allData = null;
let charts = {};
let currentPeriod = 60;

// â”€â”€â”€ Data Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadData() {
  try {
    const resp = await fetch('data/etf_flows.json');
    if (!resp.ok) throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
    allData = await resp.json();
    console.log(`[ETF] Loaded ${allData.daily_flows.length} records`);
    renderDashboard();
  } catch (e) {
    console.error('Failed to load data:', e);
    document.getElementById('summaryCards').innerHTML =
      '<div class="loading" style="color: var(--red);">ë°ì´í„° ë¡œë”© ì‹¤íŒ¨ â€” data/etf_flows.json íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”<br><small>' + e.message + '</small></div>';
  }
}

function getFilteredData() {
  if (!allData) return [];
  const flows = allData.daily_flows;
  if (currentPeriod === 0) return flows;
  return flows.slice(-currentPeriod);
}

// â”€â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt(val) {
  if (val === 0) return '0.0';
  const sign = val > 0 ? '+' : '';
  return sign + val.toLocaleString('en-US', { minimumFractionDigits: 1, maximumFractionDigits: 1 });
}

function fmtShort(val) {
  const abs = Math.abs(val);
  if (abs >= 1000) return (val > 0 ? '+' : '') + (val / 1000).toFixed(1) + 'B';
  return fmt(val);
}

function formatDate(iso) {
  const d = new Date(iso + 'T00:00:00');
  return `${d.getMonth() + 1}/${d.getDate()}`;
}

function formatDateFull(iso) {
  const d = new Date(iso + 'T00:00:00');
  return `${d.getFullYear()}.${String(d.getMonth() + 1).padStart(2, '0')}.${String(d.getDate()).padStart(2, '0')}`;
}

function getWeekKey(iso) {
  const d = new Date(iso + 'T00:00:00');
  const onejan = new Date(d.getFullYear(), 0, 1);
  const week = Math.ceil(((d - onejan) / 86400000 + onejan.getDay() + 1) / 7);
  return `${d.getFullYear()}-W${String(week).padStart(2, '0')}`;
}

// â”€â”€â”€ Render All â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDashboard() {
  const data = getFilteredData();
  if (!data.length) return;

  renderSummaryCards(data);
  renderDailyFlowChart(data);
  renderCumulativeChart(data);
  renderETFShareChart(data);
  renderStackedChart(data);
  renderETFTable(data);
  renderDailyTable(data);
  renderWeeklyChart(data);

  // Update header
  if (allData.metadata.last_updated) {
    const d = new Date(allData.metadata.last_updated);
    document.getElementById('lastUpdated').textContent = `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${d.toLocaleDateString('ko-KR')}`;
  }
}

// â”€â”€â”€ Summary Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSummaryCards(data) {
  const latest = data[data.length - 1];
  const cumulative = data.reduce((sum, d) => sum + d.total, 0);
  
  // Streak
  let streak = 0;
  const lastSign = latest.total >= 0 ? 1 : -1;
  for (let i = data.length - 1; i >= 0; i--) {
    if ((data[i].total >= 0 ? 1 : -1) === lastSign) streak++;
    else break;
  }

  // 7-day total
  const last7 = data.slice(-7);
  const weekTotal = last7.reduce((sum, d) => sum + d.total, 0);

  // Average daily
  const avgDaily = cumulative / data.length;

  // Biggest single day
  let maxDay = data[0], minDay = data[0];
  data.forEach(d => {
    if (d.total > maxDay.total) maxDay = d;
    if (d.total < minDay.total) minDay = d;
  });

  const cards = [
    {
      label: 'ìµœê·¼ ì¼ë³„ ìˆœìœ ì…',
      value: fmt(latest.total),
      cls: latest.total >= 0 ? 'positive' : 'negative',
      sub: formatDateFull(latest.date),
    },
    {
      label: 'ê¸°ê°„ ëˆ„ì ',
      value: fmtShort(cumulative),
      cls: cumulative >= 0 ? 'positive' : 'negative',
      sub: `${data.length}ê±°ë˜ì¼ í•©ê³„`,
    },
    {
      label: 'ìµœê·¼ 7ì¼',
      value: fmt(weekTotal),
      cls: weekTotal >= 0 ? 'positive' : 'negative',
      sub: `ì¼í‰ê·  ${fmt(weekTotal / Math.min(7, last7.length))}M`,
    },
    {
      label: lastSign > 0 ? 'ì—°ì† ìœ ì…' : 'ì—°ì† ìœ ì¶œ',
      value: `${streak}ì¼`,
      cls: 'neutral',
      sub: lastSign > 0 ? 'ğŸ“ˆ ìœ ì… ì§€ì† ì¤‘' : 'ğŸ“‰ ìœ ì¶œ ì§€ì† ì¤‘',
    },
    {
      label: 'ìµœëŒ€ ìœ ì…ì¼',
      value: fmt(maxDay.total),
      cls: 'positive',
      sub: formatDateFull(maxDay.date),
    },
    {
      label: 'ìµœëŒ€ ìœ ì¶œì¼',
      value: fmt(minDay.total),
      cls: 'negative',
      sub: formatDateFull(minDay.date),
    },
  ];

  document.getElementById('summaryCards').innerHTML = cards.map(c => `
    <div class="card">
      <div class="card-label">${c.label}</div>
      <div class="card-value ${c.cls}">${c.value}</div>
      <div class="card-sub">${c.sub}</div>
    </div>
  `).join('');
}

// â”€â”€â”€ Daily Flow Bar Chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDailyFlowChart(data) {
  const ctx = document.getElementById('dailyFlowChart');
  if (charts.daily) charts.daily.destroy();

  const bgColors = data.map(d => d.total >= 0 ? '#00d68f' : '#ff3d71');
  const hoverBg = data.map(d => d.total >= 0 ? '#00d68fcc' : '#ff3d71cc');

  charts.daily = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: data.map(d => formatDate(d.date)),
      datasets: [{
        label: 'ìˆœìœ ì… (US$M)',
        data: data.map(d => d.total),
        backgroundColor: bgColors,
        hoverBackgroundColor: hoverBg,
        borderWidth: 0,
        borderRadius: 2,
        barPercentage: 0.85,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#1a1a28',
          borderColor: '#2a2a45',
          borderWidth: 1,
          titleColor: '#e8e8f0',
          bodyColor: '#e8e8f0',
          padding: 12,
          callbacks: {
            title: (items) => {
              const idx = items[0].dataIndex;
              return formatDateFull(data[idx].date);
            },
            label: (item) => {
              const val = item.raw;
              const sign = val >= 0 ? '+' : '';
              return `ìˆœìœ ì…: ${sign}${val.toFixed(1)}M`;
            },
            afterLabel: (item) => {
              const idx = item.dataIndex;
              const d = data[idx];
              const lines = [];
              TOP_ETFS.forEach(t => {
                const v = d.flows[t];
                if (v !== 0) lines.push(`  ${t}: ${v > 0 ? '+' : ''}${v.toFixed(1)}M`);
              });
              return lines;
            }
          }
        }
      },
      scales: {
        x: {
          grid: { display: false },
          ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 15 }
        },
        y: {
          grid: { color: '#1e1e3044' },
          ticks: {
            callback: v => (v > 0 ? '+' : '') + v
          }
        }
      }
    }
  });
}

// â”€â”€â”€ Cumulative Chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCumulativeChart(data) {
  const ctx = document.getElementById('cumulativeChart');
  if (charts.cumulative) charts.cumulative.destroy();

  let cumulative = 0;
  const cumData = data.map(d => {
    cumulative += d.total;
    return cumulative;
  });

  charts.cumulative = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.map(d => formatDate(d.date)),
      datasets: [{
        label: 'ëˆ„ì  ìˆœìœ ì… (US$M)',
        data: cumData,
        borderColor: '#3366ff',
        backgroundColor: '#3366ff15',
        fill: true,
        tension: 0.3,
        pointRadius: 0,
        pointHoverRadius: 5,
        borderWidth: 2,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#1a1a28',
          borderColor: '#2a2a45',
          borderWidth: 1,
          callbacks: {
            title: (items) => formatDateFull(data[items[0].dataIndex].date),
            label: (item) => `ëˆ„ì : ${fmt(item.raw)}M`
          }
        }
      },
      scales: {
        x: {
          grid: { display: false },
          ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 8 }
        },
        y: {
          grid: { color: '#1e1e3044' },
          ticks: { callback: v => fmtShort(v) }
        }
      }
    }
  });
}

// â”€â”€â”€ ETF Share Doughnut â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderETFShareChart(data) {
  const ctx = document.getElementById('etfShareChart');
  if (charts.share) charts.share.destroy();

  // Calc total inflows per ETF
  const totals = {};
  allData.metadata.tickers.forEach(t => { totals[t] = 0; });
  data.forEach(d => {
    Object.entries(d.flows).forEach(([t, v]) => {
      totals[t] = (totals[t] || 0) + v;
    });
  });

  // Sort by absolute value
  const sorted = Object.entries(totals).sort((a, b) => Math.abs(b[1]) - Math.abs(a[1]));
  const top6 = sorted.slice(0, 6);
  const othersVal = sorted.slice(6).reduce((s, [_, v]) => s + v, 0);

  const labels = top6.map(([t]) => t).concat(othersVal !== 0 ? ['ê¸°íƒ€'] : []);
  const values = top6.map(([_, v]) => v).concat(othersVal !== 0 ? [othersVal] : []);
  const colors = top6.map(([t]) => COLORS[t]).concat(['#555570']);

  charts.share = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        data: values.map(Math.abs),
        backgroundColor: colors,
        borderColor: '#12121a',
        borderWidth: 2,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '65%',
      plugins: {
        legend: {
          position: 'right',
          labels: { padding: 12, font: { size: 11 } }
        },
        tooltip: {
          backgroundColor: '#1a1a28',
          borderColor: '#2a2a45',
          borderWidth: 1,
          callbacks: {
            label: (item) => {
              const val = values[item.dataIndex];
              return ` ${item.label}: ${fmt(val)}M`;
            }
          }
        }
      }
    }
  });
}

// â”€â”€â”€ Stacked Bar Chart (Top 5 ETFs) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderStackedChart(data) {
  const ctx = document.getElementById('stackedChart');
  if (charts.stacked) charts.stacked.destroy();

  const datasets = TOP_ETFS.map(ticker => ({
    label: ticker,
    data: data.map(d => d.flows[ticker] || 0),
    backgroundColor: COLORS[ticker] + 'cc',
    borderWidth: 0,
    borderRadius: 1,
    barPercentage: 0.9,
  }));

  charts.stacked = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: data.map(d => formatDate(d.date)),
      datasets,
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'top',
          labels: { padding: 16 }
        },
        tooltip: {
          backgroundColor: '#1a1a28',
          borderColor: '#2a2a45',
          borderWidth: 1,
          mode: 'index',
          callbacks: {
            title: (items) => formatDateFull(data[items[0].dataIndex].date),
            label: (item) => ` ${item.dataset.label}: ${fmt(item.raw)}M`,
          }
        }
      },
      scales: {
        x: {
          stacked: true,
          grid: { display: false },
          ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 15 }
        },
        y: {
          stacked: true,
          grid: { color: '#1e1e3044' },
          ticks: { callback: v => (v > 0 ? '+' : '') + v }
        }
      }
    }
  });
}

// â”€â”€â”€ ETF Summary Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderETFTable(data) {
  const totals = {};
  allData.metadata.tickers.forEach(t => { totals[t] = 0; });
  data.forEach(d => {
    Object.entries(d.flows).forEach(([t, v]) => {
      totals[t] = (totals[t] || 0) + v;
    });
  });

  const sorted = Object.entries(totals).sort((a, b) => b[1] - a[1]);
  const maxAbs = Math.max(...sorted.map(([_, v]) => Math.abs(v)), 1);

  const info = allData.metadata.etf_info;

  let html = `<table class="etf-table">
    <thead><tr>
      <th>ETF</th>
      <th>ë°œí–‰ì‚¬</th>
      <th style="text-align:right">ìˆœìœ ì… (US$M)</th>
      <th>ë¹„ì¤‘</th>
    </tr></thead><tbody>`;

  sorted.forEach(([ticker, total]) => {
    const cls = total > 0.5 ? 'pos' : total < -0.5 ? 'neg' : 'zero';
    const pct = (Math.abs(total) / maxAbs) * 100;
    const barCls = total >= 0 ? 'pos' : 'neg';

    html += `<tr>
      <td class="ticker" style="color: ${COLORS[ticker] || 'inherit'}">${ticker}</td>
      <td class="issuer">${info[ticker]?.issuer || '-'}</td>
      <td class="flow-value ${cls}" style="text-align:right">${fmt(total)}</td>
      <td class="flow-bar-cell">
        <div class="flow-bar-wrap">
          <div class="flow-bar ${barCls}" style="width: ${pct}%"></div>
        </div>
      </td>
    </tr>`;
  });

  html += '</tbody></table>';
  document.getElementById('etfTableWrap').innerHTML = html;
}

// â”€â”€â”€ Daily Detail Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDailyTable(data) {
  const recent = data.slice(-10).reverse();
  const mainTickers = ['IBIT', 'FBTC', 'GBTC', 'ARKB', 'BITB'];

  let html = `<table class="daily-table">
    <thead><tr>
      <th>ë‚ ì§œ</th>
      ${mainTickers.map(t => `<th>${t}</th>`).join('')}
      <th>í•©ê³„</th>
    </tr></thead><tbody>`;

  recent.forEach(d => {
    html += `<tr>
      <td>${formatDate(d.date)}</td>
      ${mainTickers.map(t => {
        const v = d.flows[t] || 0;
        const cls = v > 0.5 ? 'pos' : v < -0.5 ? 'neg' : 'zero';
        return `<td class="${cls}">${v > 0 ? '+' : ''}${v.toFixed(1)}</td>`;
      }).join('')}
      <td class="total-col ${d.total >= 0 ? 'pos' : 'neg'}">${fmt(d.total)}</td>
    </tr>`;
  });

  html += '</tbody></table>';
  document.getElementById('dailyTableWrap').innerHTML = html;
}

// â”€â”€â”€ Weekly Chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderWeeklyChart(data) {
  const ctx = document.getElementById('weeklyChart');
  if (charts.weekly) charts.weekly.destroy();

  const weeks = {};
  data.forEach(d => {
    const wk = getWeekKey(d.date);
    if (!weeks[wk]) weeks[wk] = { total: 0, count: 0 };
    weeks[wk].total += d.total;
    weeks[wk].count++;
  });

  const weekLabels = Object.keys(weeks).sort();
  const weekTotals = weekLabels.map(w => Math.round(weeks[w].total * 10) / 10);

  charts.weekly = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: weekLabels,
      datasets: [{
        label: 'ì£¼ê°„ ìˆœìœ ì… (US$M)',
        data: weekTotals,
        backgroundColor: weekTotals.map(v => v >= 0 ? '#00d68f88' : '#ff3d7188'),
        borderColor: weekTotals.map(v => v >= 0 ? '#00d68f' : '#ff3d71'),
        borderWidth: 1,
        borderRadius: 4,
        barPercentage: 0.7,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#1a1a28',
          borderColor: '#2a2a45',
          borderWidth: 1,
          callbacks: {
            label: (item) => `ì£¼ê°„ í•©ê³„: ${fmt(item.raw)}M`
          }
        }
      },
      scales: {
        x: {
          grid: { display: false },
          ticks: { font: { size: 10 } }
        },
        y: {
          grid: { color: '#1e1e3044' },
          ticks: { callback: v => (v > 0 ? '+' : '') + v }
        }
      }
    }
  });
}

// â”€â”€â”€ Period Selector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.period-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelector('.period-btn.active').classList.remove('active');
    btn.classList.add('active');
    currentPeriod = parseInt(btn.dataset.period);
    renderDashboard();
  });
});

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadData();
</script>
</body>
</html>
