<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>S&P 500 ë°¸ë¥˜ì—ì´ì…˜ ìŠ¤í¬ë¦¬ë„ˆ</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+KR:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root{--bg-primary:#06080a;--bg-secondary:#0d1117;--bg-card:#131921;--bg-card-hover:#1a2233;--bg-elevated:#1c2536;--border:#1e2d3d;--border-light:#253449;--text-primary:#e6edf3;--text-secondary:#8b949e;--text-muted:#555d66;--green:#00e5a0;--green-dim:#0a3d2e;--green-bg:rgba(0,229,160,0.08);--red:#ff5c5c;--red-dim:#3d1515;--red-bg:rgba(255,92,92,0.08);--yellow:#ffc857;--yellow-dim:#3d3015;--yellow-bg:rgba(255,200,87,0.08);--blue:#58a6ff;--gold:#d4a843;--accent:#00e5a0}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg-primary);color:var(--text-primary);font-family:'IBM Plex Sans KR',sans-serif;min-height:100vh;overflow-x:hidden}
.header{background:linear-gradient(180deg,#0a1020,var(--bg-primary));border-bottom:1px solid var(--border);padding:24px 24px 18px;position:relative;overflow:hidden}
.header::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--accent),var(--gold),var(--accent),transparent)}
.header-grid{position:absolute;inset:0;background-image:linear-gradient(rgba(0,229,160,.02) 1px,transparent 1px),linear-gradient(90deg,rgba(0,229,160,.02) 1px,transparent 1px);background-size:40px 40px;pointer-events:none}
.header-content{max-width:1400px;margin:0 auto;position:relative;z-index:1}
.header-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:12px}
.logo-area{display:flex;align-items:center;gap:12px}
.logo-icon{width:40px;height:40px;background:linear-gradient(135deg,var(--accent),var(--gold));border-radius:10px;display:flex;align-items:center;justify-content:center;font-family:'Outfit',sans-serif;font-weight:800;font-size:16px;color:var(--bg-primary)}
.title-block h1{font-family:'Outfit',sans-serif;font-weight:700;font-size:20px;letter-spacing:-.5px;background:linear-gradient(135deg,#fff 40%,var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.title-block .subtitle{font-size:11px;color:var(--text-muted);margin-top:1px;font-family:'JetBrains Mono',monospace}
.update-badge{background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:7px 12px;font-size:11px;color:var(--text-secondary);font-family:'JetBrains Mono',monospace;display:flex;align-items:center;gap:6px}
.update-dot{width:6px;height:6px;background:var(--accent);border-radius:50%;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.stats-bar{display:flex;gap:20px;flex-wrap:wrap}
.stat-item{display:flex;align-items:center;gap:6px;font-size:12px}
.stat-label{color:var(--text-muted)}.stat-value{font-family:'JetBrains Mono',monospace;font-weight:500}
.tab-nav{background:var(--bg-secondary);border-bottom:1px solid var(--border);padding:0 24px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.tab-nav::-webkit-scrollbar{display:none}
.tab-nav-inner{max-width:1400px;margin:0 auto;display:flex}
.tab-btn{background:none;border:none;color:var(--text-muted);font-family:'IBM Plex Sans KR',sans-serif;font-size:13px;font-weight:500;padding:13px 18px;cursor:pointer;white-space:nowrap;position:relative;transition:color .2s;display:flex;align-items:center;gap:7px}
.tab-btn:hover{color:var(--text-secondary)}
.tab-btn.active{color:var(--accent)}
.tab-btn.active::after{content:'';position:absolute;bottom:0;left:14px;right:14px;height:2px;background:var(--accent);border-radius:2px 2px 0 0}
.tab-emoji{font-size:14px}
.tab-content{max-width:1400px;margin:0 auto;padding:20px 24px;display:none}
.tab-content.active{display:block;animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.filter-bar{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
.filter-select,.search-input{background:var(--bg-elevated);border:1px solid var(--border-light);color:var(--text-primary);font-family:'IBM Plex Sans KR',sans-serif;font-size:12px;padding:8px 14px;border-radius:7px;cursor:pointer;transition:border-color .2s}
.filter-select option{background:var(--bg-card);color:var(--text-primary)}
.search-input{font-family:'JetBrains Mono',monospace;width:180px}
.search-input::placeholder{color:var(--text-secondary)}
.search-input:focus,.filter-select:focus{outline:none;border-color:var(--accent)}
.th-wrap{display:flex;align-items:center;gap:4px}
.tip-icon{width:14px;height:14px;border-radius:50%;background:rgba(255,255,255,.06);color:var(--text-muted);font-size:9px;display:inline-flex;align-items:center;justify-content:center;cursor:help;position:relative;flex-shrink:0}
.tip-icon:hover{background:rgba(0,229,160,.15);color:var(--accent)}
.tip-box{display:none;position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);background:#1c2536;border:1px solid var(--border-light);border-radius:8px;padding:10px 12px;font-size:11px;font-family:'IBM Plex Sans KR',sans-serif;color:var(--text-primary);width:220px;text-transform:none;letter-spacing:0;font-weight:400;line-height:1.5;z-index:100;box-shadow:0 8px 24px rgba(0,0,0,.4);white-space:normal;text-align:left}
.tip-box::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:6px solid transparent;border-top-color:#1c2536}
.tip-icon:hover .tip-box{display:block}
.table-wrap{overflow-x:auto;border-radius:10px;border:1px solid var(--border)}
.data-table{width:100%;border-collapse:collapse;font-size:13px;min-width:700px}
.data-table thead th{background:var(--bg-card);color:var(--text-secondary);font-weight:500;font-size:10px;text-transform:uppercase;letter-spacing:.5px;padding:10px 14px;text-align:left;border-bottom:1px solid var(--border);position:sticky;top:0;cursor:pointer;white-space:nowrap;font-family:'JetBrains Mono',monospace}
.data-table thead th:hover{color:var(--text-primary)}
.data-table tbody tr{transition:background .12s}
.data-table tbody tr:hover{background:var(--bg-card-hover)}
.data-table tbody td{padding:10px 14px;border-bottom:1px solid rgba(30,45,61,.3);font-family:'JetBrains Mono',monospace;font-size:12px}
.ticker-cell{display:flex;align-items:center;gap:8px}
.ticker-logo{width:26px;height:26px;border-radius:5px;background:var(--bg-elevated);display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:700;color:var(--text-muted);border:1px solid var(--border);flex-shrink:0}
.ticker-name{font-family:'Outfit',sans-serif;font-weight:600;font-size:13px}
.ticker-company{font-family:'IBM Plex Sans KR',sans-serif;font-size:10px;color:var(--text-muted);margin-top:1px;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.sector-badge{background:var(--bg-elevated);border:1px solid var(--border);color:var(--text-secondary);font-size:10px;padding:2px 7px;border-radius:4px;white-space:nowrap}
.val-low{color:var(--green)}.val-mid{color:var(--yellow)}.val-high{color:var(--red)}
.pagination{display:flex;align-items:center;justify-content:center;gap:6px;margin-top:14px}
.page-btn{background:var(--bg-card);border:1px solid var(--border);color:var(--text-secondary);font-family:'JetBrains Mono',monospace;font-size:12px;padding:6px 12px;border-radius:6px;cursor:pointer;transition:all .2s}
.page-btn:hover{border-color:var(--border-light);color:var(--text-primary)}
.page-btn.active{border-color:var(--accent);color:var(--accent);background:rgba(0,229,160,.06)}
.page-info{font-size:11px;color:var(--text-muted);font-family:'JetBrains Mono',monospace}
.split-grid{display:grid;grid-template-columns:1fr 1fr;gap:24px}
.split-section-title{font-family:'Outfit',sans-serif;font-weight:600;font-size:15px;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.discount-list{display:flex;flex-direction:column;gap:5px}
.discount-row{display:flex;align-items:center;gap:10px;padding:9px 14px;background:var(--bg-card);border-radius:7px;border:1px solid var(--border);transition:border-color .2s}
.discount-row:hover{border-color:var(--border-light)}
.discount-rank{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-muted);width:20px;text-align:center}
.discount-ticker{font-family:'Outfit',sans-serif;font-weight:600;font-size:12px;width:48px}
.discount-bar-wrap{flex:1;height:18px;background:rgba(255,255,255,.02);border-radius:3px;overflow:hidden}
.discount-bar-fill{height:100%;border-radius:3px;transition:width .6s}
.discount-bar-fill.neg{background:linear-gradient(90deg,var(--red),var(--red-dim))}
.discount-bar-fill.pos{background:linear-gradient(90deg,var(--green-dim),var(--green))}
.discount-pct{font-family:'JetBrains Mono',monospace;font-weight:600;font-size:12px;width:58px;text-align:right}
.chart-panel{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;margin-bottom:20px;overflow:hidden}
.chart-panel-header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:10px}
.chart-panel-title{font-family:'Outfit',sans-serif;font-weight:700;font-size:16px;display:flex;align-items:center;gap:8px}
.chart-panel-subtitle{font-size:11px;color:var(--text-muted);font-family:'JetBrains Mono',monospace}
.chart-panel-empty{padding:50px 20px;text-align:center;color:var(--text-muted);font-size:13px}
.chart-panel-body{position:relative}
.chart-period-btns{display:flex;gap:4px}
.period-btn{background:var(--bg-elevated);border:1px solid var(--border);color:var(--text-secondary);font-family:'JetBrains Mono',monospace;font-size:10px;padding:4px 10px;border-radius:4px;cursor:pointer;transition:all .15s}
.period-btn:hover{border-color:var(--border-light);color:var(--text-primary)}
.period-btn.active{border-color:var(--accent);color:var(--accent);background:rgba(0,229,160,.06)}
.chart-dual{display:flex;flex-direction:column}
.chart-dual-left{border-bottom:1px solid var(--border);height:320px}
.chart-dual-left iframe{height:100%!important}
.chart-dual-right{padding:16px;height:320px;overflow:hidden;position:relative}
.chart-dual-right canvas{position:absolute;left:16px;right:16px;top:60px;bottom:40px}
@media(min-width:769px){.chart-sticky{position:sticky;top:0;z-index:10}}
@media(max-width:768px){.chart-dual-left{height:280px}.chart-dual-right{height:260px}.split-grid{grid-template-columns:1fr}}
.score-section{margin-bottom:28px}
.score-section-title{font-family:'Outfit',sans-serif;font-weight:700;font-size:15px;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.score-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:10px}
.score-card{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:14px;transition:all .2s;cursor:pointer}
.score-card:hover{border-color:var(--border-light)}
.score-card.selected{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent),0 0 20px rgba(0,229,160,.08)}
.score-card-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.score-card-rank{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-muted)}
.score-card-ticker-row{display:flex;align-items:center;gap:8px}
.score-card-ticker{font-family:'Outfit',sans-serif;font-weight:700;font-size:15px}
.score-badge{padding:3px 9px;border-radius:5px;font-family:'JetBrains Mono',monospace;font-weight:600;font-size:13px}
.score-badge.green{background:var(--green-bg);color:var(--green);border:1px solid rgba(0,229,160,.2)}
.score-badge.red{background:var(--red-bg);color:var(--red);border:1px solid rgba(255,92,92,.2)}
.score-bar-track{height:5px;background:rgba(255,255,255,.03);border-radius:3px;margin-bottom:10px;overflow:hidden}
.score-bar-fill{height:100%;border-radius:3px}
.score-metrics{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}
.score-metric{text-align:center}
.score-metric-label{font-size:9px;color:var(--text-muted);margin-bottom:2px;font-family:'JetBrains Mono',monospace}
.score-metric-val{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:500}
.heatmap-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.heatmap-cell{border-radius:10px;padding:16px;min-height:100px;display:flex;flex-direction:column;justify-content:space-between;transition:transform .2s;cursor:pointer;border:1px solid transparent}
.heatmap-cell:hover{transform:scale(1.02);border-color:rgba(255,255,255,.08)}
.heatmap-cell.lg{grid-column:span 2;grid-row:span 2;min-height:220px}
.heatmap-cell.md{grid-column:span 2}
.heatmap-cell.cheap{background:linear-gradient(135deg,#062920,#0a3d2e)}
.heatmap-cell.neutral{background:linear-gradient(135deg,#2a2510,#3d3015)}
.heatmap-cell.expensive{background:linear-gradient(135deg,#2d1010,#3d1515)}
.heatmap-sector{font-family:'Outfit',sans-serif;font-weight:600;font-size:14px}
.heatmap-sector-kr{font-size:11px;color:var(--text-secondary);margin-top:2px}
.heatmap-cell.lg .heatmap-sector{font-size:18px}
.heatmap-cell.lg .heatmap-sector-kr{font-size:13px}
.heatmap-pe{font-family:'JetBrains Mono',monospace;font-size:26px;font-weight:700}
.heatmap-cell.lg .heatmap-pe{font-size:40px}
.heatmap-label{font-size:10px;color:var(--text-muted);font-family:'JetBrains Mono',monospace}
.heatmap-count{font-size:10px;color:var(--text-muted)}
.thermo-list{display:flex;flex-direction:column;gap:4px}
.thermo-header{display:grid;grid-template-columns:55px 100px 1fr 65px 90px;gap:10px;padding:8px 14px;font-size:10px;text-transform:uppercase;letter-spacing:.4px;color:var(--text-muted);font-family:'JetBrains Mono',monospace}
.thermo-row{display:grid;grid-template-columns:55px 100px 1fr 65px 90px;gap:10px;align-items:center;padding:9px 14px;background:var(--bg-card);border-radius:7px;border:1px solid var(--border);transition:border-color .2s}
.thermo-row:hover{border-color:var(--border-light)}
.thermo-ticker{font-family:'Outfit',sans-serif;font-weight:600;font-size:12px}
.thermo-name{font-size:10px;color:var(--text-secondary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.thermo-bar-wrap{position:relative;height:22px;background:linear-gradient(90deg,var(--green-dim) 0%,var(--yellow-dim) 50%,var(--red-dim) 100%);border-radius:4px}
.thermo-marker{position:absolute;top:-1px;width:3px;height:24px;background:#fff;border-radius:2px;box-shadow:0 0 6px rgba(255,255,255,.4)}
.thermo-pct{font-family:'JetBrains Mono',monospace;font-weight:600;font-size:12px;text-align:right}
.thermo-signal{text-align:center;font-size:10px;font-weight:600;padding:3px 8px;border-radius:5px;white-space:nowrap}
.sig-cheap{background:var(--green-bg);color:var(--green)}
.sig-fair{background:var(--yellow-bg);color:var(--yellow)}
.sig-exp{background:var(--red-bg);color:var(--red)}
.hist-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px}
.hist-card{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:16px;transition:all .2s;cursor:pointer}
.hist-card:hover{border-color:var(--border-light)}
.hist-card.selected{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent),0 0 20px rgba(0,229,160,.08)}
.hist-card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.hist-ticker{font-family:'Outfit',sans-serif;font-weight:700;font-size:16px}
.hist-zone{font-size:10px;padding:3px 8px;border-radius:5px;font-weight:600}
.hist-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px}
.hist-stat{text-align:center;padding:8px;background:rgba(255,255,255,.015);border-radius:7px}
.hist-stat-label{font-size:9px;color:var(--text-muted);margin-bottom:2px;font-family:'JetBrains Mono',monospace}
.hist-stat-val{font-family:'JetBrains Mono',monospace;font-weight:600;font-size:15px}
.hist-case{display:flex;align-items:center;justify-content:space-between;padding:5px 10px;background:rgba(255,255,255,.015);border-radius:5px;margin-bottom:3px;font-size:11px}
.hist-case-date{font-family:'JetBrains Mono',monospace;color:var(--text-secondary)}
.hist-case-pe{font-family:'JetBrains Mono',monospace;color:var(--text-muted);font-size:10px}
.hist-case-result{font-family:'JetBrains Mono',monospace;font-weight:600}
.info-box{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:16px 18px;margin-bottom:18px;font-size:13px;line-height:1.7;color:var(--text-secondary)}
.info-box strong{color:var(--text-primary);font-weight:600}
.info-box .info-title{font-family:'Outfit',sans-serif;font-weight:600;font-size:14px;color:var(--text-primary);margin-bottom:6px}
.legend{display:flex;gap:14px;margin-top:16px;padding:10px 14px;background:var(--bg-card);border-radius:7px;border:1px solid var(--border);flex-wrap:wrap}
.legend-item{display:flex;align-items:center;gap:5px;font-size:10px;color:var(--text-secondary)}
.legend-dot{width:7px;height:7px;border-radius:2px}
@media(max-width:900px){.heatmap-grid{grid-template-columns:repeat(2,1fr)}.heatmap-cell.lg{grid-column:span 2;grid-row:span 1;min-height:120px}}
@media(max-width:768px){.header{padding:18px 16px 14px}.tab-content{padding:16px}.score-grid{grid-template-columns:1fr}.hist-grid{grid-template-columns:1fr}.thermo-header,.thermo-row{grid-template-columns:50px 1fr 55px 80px}.thermo-header>:nth-child(2),.thermo-row>:nth-child(2){display:none}.heatmap-pe{font-size:20px}.heatmap-cell.lg .heatmap-pe{font-size:30px}}
@media(max-width:480px){.heatmap-grid{grid-template-columns:1fr 1fr}.heatmap-cell.md{grid-column:span 2}}
</style>
</head>
<body>
<div class="header"><div class="header-grid"></div><div class="header-content">
<div class="header-top"><div class="logo-area"><div class="logo-icon">VS</div><div class="title-block"><h1>S&P 500 ë°¸ë¥˜ì—ì´ì…˜ ìŠ¤í¬ë¦¬ë„ˆ</h1><div class="subtitle">Undervalued & Overvalued Stocks Finder</div></div></div><div class="update-badge"><span class="update-dot"></span><span id="update-time">Loading...</span></div></div>
<div class="stats-bar" id="stats-bar"></div></div></div>

<div class="tab-nav"><div class="tab-nav-inner">
<button class="tab-btn active" onclick="switchTab(0)"><span class="tab-emoji">ğŸ“Š</span> ë°¸ë¥˜ì—ì´ì…˜ ë­í‚¹</button>
<button class="tab-btn" onclick="switchTab(1)"><span class="tab-emoji">ğŸ“‰</span> 52ì£¼ ê³ ì  ëŒ€ë¹„</button>
<button class="tab-btn" onclick="switchTab(2)"><span class="tab-emoji">ğŸ†</span> ì¢…í•© ìŠ¤ì½”ì–´</button>
<button class="tab-btn" onclick="switchTab(3)"><span class="tab-emoji">ğŸ—ºï¸</span> ì„¹í„° íˆíŠ¸ë§µ</button>
<button class="tab-btn" onclick="switchTab(4)"><span class="tab-emoji">ğŸŒ¡ï¸</span> ë°¸ë¥˜ì—ì´ì…˜ ì˜¨ë„ê³„</button>
<button class="tab-btn" onclick="switchTab(5)"><span class="tab-emoji">â±ï¸</span> ì—­ì‚¬ì  ì„±ê³¼</button>
</div></div>

<div class="tab-content active" id="tab-0">
<div class="filter-bar">
<select class="filter-select" id="f-sector" onchange="renderTab1()"><option value="">ì „ì²´ ì„¹í„°</option></select>
<select class="filter-select" id="f-sort" onchange="renderTab1()">
<option value="pe-asc">P/E ë‚®ì€ìˆœ â†‘</option><option value="pe-desc">P/E ë†’ì€ìˆœ â†“</option>
<option value="pb-asc">P/B ë‚®ì€ìˆœ</option><option value="peg-asc">PEG ë‚®ì€ìˆœ</option>
<option value="score-desc">Value Score ë†’ì€ìˆœ</option><option value="discount-asc">52ì£¼ í• ì¸ìœ¨ìˆœ</option>
</select>
<input type="text" class="search-input" id="f-search" placeholder="ğŸ” ì¢…ëª© ê²€ìƒ‰" oninput="renderTab1()">
</div>
<div class="table-wrap"><table class="data-table" id="table-1"><thead></thead><tbody></tbody></table></div>
<div class="pagination" id="pagination-1"></div>
<div class="legend"><div class="legend-item"><div class="legend-dot" style="background:var(--green)"></div>ì €í‰ê°€</div><div class="legend-item"><div class="legend-dot" style="background:var(--yellow)"></div>ì ì •ê°€</div><div class="legend-item"><div class="legend-dot" style="background:var(--red)"></div>ê³ í‰ê°€</div></div>
</div>

<div class="tab-content" id="tab-1"><div id="tab2-content"></div></div>

<div class="tab-content" id="tab-2">
<div class="chart-panel chart-sticky" id="score-chart-panel">
<div class="chart-panel-header"><div><div class="chart-panel-title" id="score-chart-title">ğŸ“ˆ ì•„ë˜ ì¢…ëª©ì„ í´ë¦­í•˜ì„¸ìš”</div><div class="chart-panel-subtitle" id="score-chart-sub"></div></div>
<div class="chart-period-btns" id="score-period-btns" style="display:none">
<button class="period-btn" onclick="setScoreP('1M')">1M</button><button class="period-btn" onclick="setScoreP('3M')">3M</button>
<button class="period-btn active" onclick="setScoreP('6M')">6M</button><button class="period-btn" onclick="setScoreP('1Y')">1Y</button><button class="period-btn" onclick="setScoreP('5Y')">5Y</button>
</div></div>
<div class="chart-panel-body" id="score-chart-body"><div class="chart-panel-empty">ğŸ‘† ì¢…ëª© ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´ TradingView ì°¨íŠ¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div></div>
</div>
<div id="tab3-content"></div>
</div>

<div class="tab-content" id="tab-3"><div class="filter-bar"><select class="filter-select" id="heatmap-metric" onchange="renderTab4()"><option value="pe">ì§€í‘œ: í‰ê·  P/E</option><option value="pb">ì§€í‘œ: í‰ê·  P/B</option></select></div><div id="tab4-content"></div></div>

<div class="tab-content" id="tab-4">
<div class="filter-bar">
<select class="filter-select" id="thermo-filter" onchange="renderTab5()"><option value="all">ì „ì²´ ì¢…ëª©</option><option value="cheap">ê·¹ë„ë¡œ ì‹¼ ì¢…ëª© (0~20%)</option><option value="expensive">ê·¹ë„ë¡œ ë¹„ì‹¼ ì¢…ëª© (80~100%)</option></select>
<select class="filter-select" id="thermo-sort" onchange="renderTab5()"><option value="asc">í¼ì„¼íƒ€ì¼ ë‚®ì€ìˆœ</option><option value="desc">í¼ì„¼íƒ€ì¼ ë†’ì€ìˆœ</option></select>
</div><div id="tab5-content"></div>
</div>

<div class="tab-content" id="tab-5">
<div class="info-box"><div class="info-title">ğŸ“Š ì—­ì‚¬ì  ë°¸ë¥˜ì—ì´ì…˜ ì„±ê³¼ ë¶„ì„</div>
ê° ì¢…ëª©ì´ <strong>ê³¼ê±°ì— í˜„ì¬ì™€ ë¹„ìŠ·í•œ P/E ìˆ˜ì¤€</strong>ì´ì—ˆì„ ë•Œ, <strong>6ê°œì›” í›„ ì£¼ê°€ê°€ ì–´ë–»ê²Œ ë³€í–ˆëŠ”ì§€</strong>ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.
ìŠ¹ë¥ ì´ ë†’ê³  í‰ê·  ìˆ˜ìµë¥ ì´ ì–‘ìˆ˜ì¸ ì¢…ëª©ì€ ê³¼ê±° íŒ¨í„´ìƒ ë°˜ë“± ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤.
<span style="color:var(--yellow)">âš ï¸ ê³¼ê±° ì„±ê³¼ê°€ ë¯¸ë˜ë¥¼ ë³´ì¥í•˜ì§€ëŠ” ì•ŠìŠµë‹ˆë‹¤. íˆ¬ì ì°¸ê³ ìš©ìœ¼ë¡œë§Œ í™œìš©í•˜ì„¸ìš”.</span></div>
<div class="chart-panel chart-sticky" id="hist-chart-panel">
<div class="chart-panel-header"><div><div class="chart-panel-title" id="hist-chart-title">ğŸ“ˆ ì•„ë˜ ì¢…ëª©ì„ í´ë¦­í•˜ì„¸ìš”</div><div class="chart-panel-subtitle" id="hist-chart-sub"></div></div></div>
<div class="chart-panel-body" id="hist-chart-body">
<div class="chart-dual">
<div class="chart-dual-left" id="hist-tv-container"><div class="chart-panel-empty">ğŸ‘† ì¢…ëª©ì„ ì„ íƒí•˜ë©´<br>TradingView ê°€ê²© ì°¨íŠ¸ í‘œì‹œ</div></div>
<div class="chart-dual-right"><div style="font-size:11px;font-family:'JetBrains Mono',monospace;margin-bottom:4px"><span style="color:var(--text-primary)">5ë…„ P/E íˆìŠ¤í† ë¦¬</span></div>
<div style="font-size:10px;color:var(--text-secondary);line-height:1.6;margin-bottom:6px">íŒŒë€ ë¼ì¸ì´ <span style="color:#00e5a0">ì´ˆë¡ ë°´ë“œ</span> ì•ˆì— ìˆìœ¼ë©´ ì—­ì‚¬ì  ì €í‰ê°€, <span style="color:#ff5c5c">ë¹¨ê°„ ë°´ë“œ</span> ì•ˆì— ìˆìœ¼ë©´ ê³ í‰ê°€.<br><span style="color:#ffc857">â—†</span> ë§ˆì»¤ = í˜„ì¬ì™€ ë¹„ìŠ·í•œ P/Eì˜€ë˜ ê³¼ê±° ì‹œì </div><canvas id="pe-history-chart"></canvas></div>
</div></div></div>
<div class="filter-bar"><select class="filter-select" id="hist-filter" onchange="renderTab6()"><option value="cheap">ì €í‰ê°€ êµ¬ê°„ ì§„ì… ì¢…ëª©</option><option value="expensive">ê³ í‰ê°€ êµ¬ê°„ ì§„ì… ì¢…ëª©</option><option value="all">ì „ì²´</option></select></div>
<div id="tab6-content"></div>
</div>

<script>
let DATA=null,tab1Page=0,peChart=null,scoreP='6M',selScore=null,selHist=null;
const PS=30;
const SKR={'Technology':'ê¸°ìˆ ','Financials':'ê¸ˆìœµ','Healthcare':'ì˜ë£Œ','Consumer Discretionary':'ì„ì˜ì†Œë¹„ì¬','Consumer Staples':'í•„ìˆ˜ì†Œë¹„ì¬','Industrials':'ì‚°ì—…ì¬','Communication Services':'í†µì‹ ì„œë¹„ìŠ¤','Energy':'ì—ë„ˆì§€','Utilities':'ìœ í‹¸ë¦¬í‹°','Real Estate':'ë¶€ë™ì‚°','Materials':'ì†Œì¬'};
const TIPS={pe:'ì£¼ê°€ìˆ˜ìµë¹„ìœ¨. í˜„ì¬ ì£¼ê°€Ã·ì£¼ë‹¹ìˆœì´ìµ(EPS). ë‚®ì„ìˆ˜ë¡ ì´ìµ ëŒ€ë¹„ ì €í‰ê°€.',fwdpe:'í–¥í›„ 12ê°œì›” ì˜ˆìƒ ì‹¤ì  ê¸°ì¤€ P/E. í˜„ì¬ë³´ë‹¤ ë‚®ìœ¼ë©´ ì‹¤ì  ê°œì„  ê¸°ëŒ€.',pb:'ì£¼ê°€ìˆœìì‚°ë¹„ìœ¨. ì£¼ê°€Ã·ì£¼ë‹¹ìˆœìì‚°. 1 ì´í•˜ë©´ ìì‚°ê°€ì¹˜ ë¯¸ë§Œ ê±°ë˜.',ps:'ì£¼ê°€ë§¤ì¶œë¹„ìœ¨. ì ì ê¸°ì—…ë„ ë¹„êµ ê°€ëŠ¥í•œ ì§€í‘œ.',peg:'P/EÃ·ì´ìµì„±ì¥ë¥ . 1 ì´í•˜ë©´ ì„±ì¥ ëŒ€ë¹„ ì €í‰ê°€, 2 ì´ìƒì€ ê³ í‰ê°€.',score:'ì—¬ëŸ¬ ë°¸ë¥˜ì—ì´ì…˜ ì§€í‘œ ì¢…í•© ì ìˆ˜. 100=ê·¹ë„ ì €í‰ê°€, 0=ê·¹ë„ ê³ í‰ê°€.'};
function tip(k){return '<span class="tip-icon">?<span class="tip-box">'+TIPS[k]+'</span></span>';}
function vc(v,t){if(v==null)return'';return v<=t[0]?'val-low':v>=t[1]?'val-high':'val-mid';}
function fn(v,d){if(v==null)return'-';return Number(v).toFixed(d===undefined?1:d);}
function ss(s){return(s||'').replace('Consumer Discretionary','C.Discret.').replace('Consumer Staples','C.Staples').replace('Communication Services','Comm.Svc.');}
function switchTab(i){document.querySelectorAll('.tab-btn').forEach((b,j)=>b.classList.toggle('active',j===i));document.querySelectorAll('.tab-content').forEach((c,j)=>c.classList.toggle('active',j===i));}

async function loadData(){try{const r=await fetch('data/sp500_data.json');DATA=await r.json();init();}catch(e){document.querySelectorAll('.tab-content').forEach(el=>{el.innerHTML='<div style="text-align:center;padding:60px;color:var(--text-muted)">âš ï¸ data/sp500_data.jsonì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';});}}
function init(){
document.getElementById('update-time').textContent=DATA.lastUpdated+' ì—…ë°ì´íŠ¸';
const s=DATA.summary;
document.getElementById('stats-bar').innerHTML='<div class="stat-item"><span class="stat-label">S&P 500 í‰ê·  P/E</span><span class="stat-value">'+s.avgPE+'</span></div><div class="stat-item"><span class="stat-label">ì €í‰ê°€</span><span class="stat-value" style="color:var(--green)">'+s.undervalued+'ê°œ</span></div><div class="stat-item"><span class="stat-label">ê³ í‰ê°€</span><span class="stat-value" style="color:var(--red)">'+s.overvalued+'ê°œ</span></div><div class="stat-item"><span class="stat-label">ì ì •ê°€</span><span class="stat-value" style="color:var(--yellow)">'+s.fairValue+'ê°œ</span></div><div class="stat-item"><span class="stat-label">ì´</span><span class="stat-value">'+s.totalStocks+'</span></div>';
const secs=[...new Set(DATA.stocks.map(s=>s.sector).filter(Boolean))].sort();
const sel=document.getElementById('f-sector');
secs.forEach(s=>{const o=document.createElement('option');o.value=s;o.textContent=s+' '+(SKR[s]||'');sel.appendChild(o);});
renderTab1();renderTab2();renderTab3();renderTab4();renderTab5();renderTab6();
}

function embedTV(ticker,containerId,height,range){
const c=document.getElementById(containerId);c.innerHTML='';
const d=document.createElement('div');d.style.height=(height||400)+'px';c.appendChild(d);
const sc=document.createElement('script');
sc.src='https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';
sc.async=true;
sc.textContent=JSON.stringify({autosize:true,symbol:ticker,interval:"D",timezone:"Asia/Seoul",theme:"dark",style:"1",locale:"kr",backgroundColor:"rgba(19,25,33,1)",gridColor:"rgba(30,45,61,0.3)",hide_top_toolbar:false,hide_legend:false,allow_symbol_change:false,save_image:false,calendar:false,range:range||"6M",hide_volume:true});
d.appendChild(sc);
}

// TAB 1
function getFS(){let st=[...DATA.stocks];const sec=document.getElementById('f-sector').value,sr=document.getElementById('f-search').value.toUpperCase(),so=document.getElementById('f-sort').value;
if(sec)st=st.filter(s=>s.sector===sec);if(sr)st=st.filter(s=>s.ticker.includes(sr)||(s.name||'').toUpperCase().includes(sr));
const[k,d]=so.split('-');const m={pe:'pe',pb:'pb',peg:'peg',score:'valueScore',discount:'discount52w'};const f=m[k]||'pe';
st.sort((a,b)=>{const av=a[f]??9999,bv=b[f]??9999;return d==='asc'?av-bv:bv-av;});return st;}
function renderTab1(){tab1Page=0;renderT1P();}
function renderT1P(){
const st=getFS(),tp=Math.ceil(st.length/PS),ps=st.slice(tab1Page*PS,(tab1Page+1)*PS);
document.querySelector('#table-1 thead').innerHTML='<tr><th style="width:40px">#</th><th>ì¢…ëª©</th><th>ì„¹í„°</th><th><div class="th-wrap">P/E '+tip('pe')+'</div></th><th><div class="th-wrap">FWD P/E '+tip('fwdpe')+'</div></th><th><div class="th-wrap">P/B '+tip('pb')+'</div></th><th><div class="th-wrap">P/S '+tip('ps')+'</div></th><th><div class="th-wrap">PEG '+tip('peg')+'</div></th><th><div class="th-wrap">SCORE '+tip('score')+'</div></th></tr>';
document.querySelector('#table-1 tbody').innerHTML=ps.map((s,i)=>{const r=tab1Page*PS+i+1;const sc=s.valueScore>=65?'val-low':s.valueScore<=35?'val-high':'val-mid';
return '<tr><td style="color:var(--text-muted)">'+r+'</td><td><div class="ticker-cell"><div class="ticker-logo">'+s.ticker.slice(0,2)+'</div><div><div class="ticker-name">'+s.ticker+'</div><div class="ticker-company">'+(s.name||'')+'</div></div></div></td><td><span class="sector-badge">'+ss(s.sector)+'</span></td><td class="'+vc(s.pe,[15,30])+'">'+fn(s.pe)+'</td><td class="'+vc(s.forwardPE,[12,28])+'">'+fn(s.forwardPE)+'</td><td class="'+vc(s.pb,[2,10])+'">'+fn(s.pb)+'</td><td class="'+vc(s.ps,[3,10])+'">'+fn(s.ps)+'</td><td class="'+vc(s.peg,[1,2])+'">'+fn(s.peg,2)+'</td><td class="'+sc+'" style="font-weight:600">'+s.valueScore+'</td></tr>';}).join('');
const pg=document.getElementById('pagination-1');if(tp<=1){pg.innerHTML='';return;}
let h='<span class="page-info">'+st.length+'ê°œ ì¤‘ '+(tab1Page*PS+1)+'-'+Math.min((tab1Page+1)*PS,st.length)+'</span>';
if(tab1Page>0)h+='<button class="page-btn" onclick="tab1Page--;renderT1P()">â—€</button>';
const sp=Math.max(0,tab1Page-4),ep=Math.min(tp,sp+9);
for(let p=sp;p<ep;p++)h+='<button class="page-btn '+(p===tab1Page?'active':'')+'" onclick="tab1Page='+p+';renderT1P()">'+(p+1)+'</button>';
if(tab1Page<tp-1)h+='<button class="page-btn" onclick="tab1Page++;renderT1P()">â–¶</button>';pg.innerHTML=h;}

// TAB 2
function renderTab2(){const st=DATA.stocks.filter(s=>s.discount52w!=null);const md=[...st].sort((a,b)=>a.discount52w-b.discount52w).slice(0,15);const nh=[...st].sort((a,b)=>b.discount52w-a.discount52w).slice(0,10);
const mr=(s,i)=>{const n=s.discount52w<-3;const w=Math.min(Math.abs(s.discount52w),60);return '<div class="discount-row"><span class="discount-rank">'+(i+1)+'</span><span class="discount-ticker" style="color:var(--'+(n?'red':'green')+')">'+s.ticker+'</span><div class="discount-bar-wrap"><div class="discount-bar-fill '+(n?'neg':'pos')+'" style="width:'+w+'%"></div></div><span class="discount-pct" style="color:var(--'+(n?'red':'green')+')">'+(s.discount52w>0?'+':'')+fn(s.discount52w)+'%</span></div>';};
document.getElementById('tab2-content').innerHTML='<div class="split-grid"><div><div class="split-section-title">ğŸ“‰ 52ì£¼ ê³ ì  ëŒ€ë¹„ ê°€ì¥ ë§ì´ í•˜ë½</div><div class="discount-list">'+md.map(mr).join('')+'</div></div><div><div class="split-section-title">ğŸ“ˆ 52ì£¼ ê³ ì  ê·¼ì ‘ (ê°•ì„¸)</div><div class="discount-list">'+nh.map(mr).join('')+'</div></div></div>';}

// TAB 3
function selScoreStock(t){selScore=t;const s=DATA.stocks.find(x=>x.ticker===t);if(!s)return;
document.getElementById('score-chart-title').innerHTML='ğŸ“ˆ '+s.ticker+' â€” '+s.name;
document.getElementById('score-chart-sub').textContent=s.sector+' Â· P/E '+fn(s.pe)+' Â· Score '+s.valueScore;
document.getElementById('score-period-btns').style.display='flex';
const rm={['1M']:'1M',['3M']:'3M',['6M']:'6M',['1Y']:'12M',['5Y']:'60M'};
embedTV(s.ticker,'score-chart-body',400,rm[scoreP]||'6M');
document.querySelectorAll('#tab3-content .score-card').forEach(c=>c.classList.remove('selected'));
const clickedSC=document.querySelector('#tab3-content .score-card[data-ticker="'+t+'"]');if(clickedSC)clickedSC.classList.add('selected');
if(window.innerWidth<769)document.getElementById('score-chart-panel').scrollIntoView({behavior:'smooth',block:'start'});}
function setScoreP(p){scoreP=p;document.querySelectorAll('#score-period-btns .period-btn').forEach(b=>b.classList.toggle('active',b.textContent===p));if(selScore)selScoreStock(selScore);}

function renderTab3(){const so=[...DATA.stocks].filter(s=>s.valueScore!=null);const t20=[...so].sort((a,b)=>b.valueScore-a.valueScore).slice(0,20);const b20=[...so].sort((a,b)=>a.valueScore-b.valueScore).slice(0,20);
const mc=(s,i,g)=>{const co=g?'green':'red';const bg=g?'background:linear-gradient(90deg,var(--green-dim),var(--green))':'background:linear-gradient(90deg,var(--red-dim),var(--red))';
return '<div class="score-card" data-ticker="'+s.ticker+'" onclick="selScoreStock(\''+s.ticker+'\')"><div class="score-card-top"><span class="score-card-rank">#'+(i+1)+'</span><div class="score-card-ticker-row"><span class="score-card-ticker">'+s.ticker+'</span><span class="sector-badge">'+ss(s.sector)+'</span></div><span class="score-badge '+co+'">'+s.valueScore+'</span></div><div class="score-bar-track"><div class="score-bar-fill" style="'+bg+';width:'+s.valueScore+'%"></div></div><div class="score-metrics"><div class="score-metric"><div class="score-metric-label">P/E</div><div class="score-metric-val '+vc(s.pe,[15,30])+'">'+fn(s.pe)+'</div></div><div class="score-metric"><div class="score-metric-label">P/B</div><div class="score-metric-val '+vc(s.pb,[2,10])+'">'+fn(s.pb)+'</div></div><div class="score-metric"><div class="score-metric-label">PEG</div><div class="score-metric-val '+vc(s.peg,[1,2])+'">'+fn(s.peg,2)+'</div></div><div class="score-metric"><div class="score-metric-label">52W</div><div class="score-metric-val '+(s.discount52w<-15?'val-low':s.discount52w>-5?'val-high':'val-mid')+'">'+fn(s.discount52w)+'%</div></div></div></div>';};
document.getElementById('tab3-content').innerHTML='<div class="score-section"><div class="score-section-title">ğŸŸ¢ TOP 20 ì €í‰ê°€ (Value Score ë†’ì€ìˆœ)</div><div class="score-grid">'+t20.map((s,i)=>mc(s,i,true)).join('')+'</div></div><div class="score-section"><div class="score-section-title">ğŸ”´ TOP 20 ê³ í‰ê°€ (Value Score ë‚®ì€ìˆœ)</div><div class="score-grid">'+b20.map((s,i)=>mc(s,i,false)).join('')+'</div></div>';}

// TAB 4
function renderTab4(){const m=document.getElementById('heatmap-metric').value;const secs=DATA.sectors;const en=Object.entries(secs).sort((a,b)=>b[1].count-a[1].count);
const gc=v=>m==='pe'?(v<16?'cheap':v>28?'expensive':'neutral'):(v<3?'cheap':v>8?'expensive':'neutral');
const gco=v=>m==='pe'?(v<16?'var(--green)':v>28?'var(--red)':'var(--yellow)'):(v<3?'var(--green)':v>8?'var(--red)':'var(--yellow)');
const lb=m==='pe'?'AVG P/E':'AVG P/B';
let h='<div class="heatmap-grid">';
en.forEach(([n,d],i)=>{const v=m==='pe'?d.avgPE:d.avgPB;if(!v)return;const sz=i===0?'lg':i<3?'md':'';const kr=SKR[n]||'';
h+='<div class="heatmap-cell '+gc(v)+' '+sz+'"><div><div class="heatmap-sector">'+n+'</div><div class="heatmap-sector-kr">'+kr+'</div><div class="heatmap-count">'+d.count+' ì¢…ëª©</div></div><div><div class="heatmap-label">'+lb+'</div><div class="heatmap-pe" style="color:'+gco(v)+'">'+fn(v)+'</div></div></div>';});
h+='</div><div class="legend" style="margin-top:14px"><div class="legend-item"><div class="legend-dot" style="background:var(--green)"></div>ì €í‰ê°€ ì„¹í„°</div><div class="legend-item"><div class="legend-dot" style="background:var(--yellow)"></div>ì ì •ê°€ ì„¹í„°</div><div class="legend-item"><div class="legend-dot" style="background:var(--red)"></div>ê³ í‰ê°€ ì„¹í„°</div></div>';
document.getElementById('tab4-content').innerHTML=h;}

// TAB 5
function renderTab5(){const f=document.getElementById('thermo-filter').value,sd=document.getElementById('thermo-sort').value;
let st=DATA.stocks.filter(s=>s.pePercentile!=null&&s.pe>0&&s.pe<500);
if(f==='cheap')st=st.filter(s=>s.pePercentile<=20);else if(f==='expensive')st=st.filter(s=>s.pePercentile>=80);
st.sort((a,b)=>sd==='asc'?a.pePercentile-b.pePercentile:b.pePercentile-a.pePercentile);st=st.slice(0,50);
const gs=p=>p<=15?['ê·¹ë„ ì €í‰ê°€','sig-cheap']:p<=30?['ì €í‰ê°€','sig-cheap']:p<=70?['ì ì •ê°€','sig-fair']:p<=85?['ê³ í‰ê°€','sig-exp']:['ê·¹ë„ ê³ í‰ê°€','sig-exp'];
const gtc=p=>p<=30?'var(--green)':p>=70?'var(--red)':'var(--text-primary)';
let h='<div class="thermo-header"><span>í‹°ì»¤</span><span>ì¢…ëª©ëª…</span><span>5ë…„ P/E ë²”ìœ„ ë‚´ í˜„ì¬ ìœ„ì¹˜</span><span>í¼ì„¼íƒ€ì¼</span><span>ì‹œê·¸ë„</span></div><div class="thermo-list">';
st.forEach(s=>{const[st2,sc]=gs(s.pePercentile);const pc=s.pePercentile<=30?'val-low':s.pePercentile>=70?'val-high':'val-mid';
h+='<div class="thermo-row"><span class="thermo-ticker" style="color:'+gtc(s.pePercentile)+'">'+s.ticker+'</span><span class="thermo-name">'+(s.name||'')+'</span><div><div class="thermo-bar-wrap"><div class="thermo-marker" style="left:'+Math.max(1,Math.min(97,s.pePercentile))+'%"></div></div></div><span class="thermo-pct '+pc+'">'+s.pePercentile+'%</span><span class="thermo-signal '+sc+'">'+st2+'</span></div>';});
h+='</div>';document.getElementById('tab5-content').innerHTML=h;}

// TAB 6
function selHistStock(t){selHist=t;const s=DATA.stocks.find(x=>x.ticker===t);if(!s)return;
const ic=s.pePercentile<=30;
document.getElementById('hist-chart-title').innerHTML='ğŸ“ˆ '+s.ticker+' â€” '+s.name;
document.getElementById('hist-chart-sub').textContent=s.sector+' Â· P/E '+fn(s.pe)+' Â· í¼ì„¼íƒ€ì¼ '+s.pePercentile+'%';
// TradingView
const tc=document.getElementById('hist-tv-container');tc.innerHTML='';
const d=document.createElement('div');d.style.height='100%';tc.appendChild(d);
const sc2=document.createElement('script');sc2.src='https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';sc2.async=true;
sc2.textContent=JSON.stringify({autosize:true,symbol:t,interval:"W",timezone:"Asia/Seoul",theme:"dark",style:"1",locale:"kr",backgroundColor:"rgba(19,25,33,1)",gridColor:"rgba(30,45,61,0.3)",hide_top_toolbar:true,hide_legend:false,allow_symbol_change:false,save_image:false,calendar:false,range:"60M",hide_volume:true});
d.appendChild(sc2);
// PE Chart
renderPEC(s);
document.querySelectorAll('#tab6-content .hist-card').forEach(c=>c.classList.remove('selected'));
const clickedCard=document.querySelector('#tab6-content .hist-card[data-ticker="'+t+'"]');if(clickedCard)clickedCard.classList.add('selected');
if(window.innerWidth<769)document.getElementById('hist-chart-panel').scrollIntoView({behavior:'smooth',block:'start'});}

function renderPEC(stock){
const ctx=document.getElementById('pe-history-chart');if(peChart)peChart.destroy();
const ph=stock.peHistory;const hp=stock.histPerformance;
if(!ph||ph.length<3){return;}
const labels=ph.map(p=>p.date),values=ph.map(p=>p.pe);
const caseDates=new Set((hp&&hp.cases||[]).map(c=>c.date));
const caseReturns={};if(hp&&hp.cases)hp.cases.forEach(c=>{caseReturns[c.date]=c.return6m;});
const ptStyle=labels.map((d,i)=>{if(i===labels.length-1)return'circle';if(caseDates.has(d))return'rectRot';return'circle';});
const ptR=labels.map((d,i)=>{if(i===labels.length-1)return 8;if(caseDates.has(d))return 7;return 1.5;});
const ptC=labels.map((d,i)=>{if(i===labels.length-1)return'#58a6ff';if(!caseDates.has(d))return'rgba(88,166,255,0.3)';return caseReturns[d]>=0?'#00e5a0':'#ff5c5c';});
const sorted=[...values].filter(v=>v>0).sort((a,b)=>a-b);
const low25=sorted[Math.floor(sorted.length*0.25)]||0;
const high75=sorted[Math.floor(sorted.length*0.75)]||999;
const bandPlugin={id:'hBands',beforeDraw:function(chart){const{ctx:c,chartArea:a,scales:{y}}=chart;if(!a)return;
const yLow=y.getPixelForValue(low25);const yHigh=y.getPixelForValue(high75);
c.save();
c.fillStyle='rgba(0,229,160,0.08)';c.fillRect(a.left,yLow,a.right-a.left,a.bottom-yLow);
c.strokeStyle='rgba(0,229,160,0.3)';c.lineWidth=1;c.setLineDash([4,4]);
c.beginPath();c.moveTo(a.left,yLow);c.lineTo(a.right,yLow);c.stroke();
c.fillStyle='rgba(255,92,92,0.08)';c.fillRect(a.left,a.top,a.right-a.left,yHigh-a.top);
c.strokeStyle='rgba(255,92,92,0.3)';
c.beginPath();c.moveTo(a.left,yHigh);c.lineTo(a.right,yHigh);c.stroke();
c.setLineDash([]);
c.font='10px JetBrains Mono';
c.fillStyle='rgba(0,229,160,0.7)';c.fillText('ì €í‰ê°€ (í•˜ìœ„ 25%)',a.right-110,Math.min(yLow+14,a.bottom-6));
c.fillStyle='rgba(255,92,92,0.7)';c.fillText('ê³ í‰ê°€ (ìƒìœ„ 25%)',a.right-110,Math.max(yHigh-6,a.top+14));
c.restore();}};
peChart=new Chart(ctx,{type:'line',data:{labels:labels,datasets:[{label:'P/E',data:values,borderColor:'#58a6ff',backgroundColor:'transparent',borderWidth:2,pointStyle:ptStyle,pointRadius:ptR,pointHoverRadius:9,pointBackgroundColor:ptC,pointBorderColor:ptC,pointBorderWidth:0,fill:false,tension:0.35}]},plugins:[bandPlugin],options:{responsive:true,maintainAspectRatio:false,layout:{padding:{bottom:20,right:4}},interaction:{mode:'index',intersect:false},plugins:{legend:{display:false},tooltip:{backgroundColor:'#1c2536',borderColor:'#253449',borderWidth:1,titleFont:{family:'JetBrains Mono',size:11},bodyFont:{family:'JetBrains Mono',size:11},callbacks:{label:function(ct){const d=labels[ct.dataIndex];let t='P/E: '+ct.raw;if(caseDates.has(d)){const r=caseReturns[d];t+=' â—† 6ê°œì›”í›„: '+(r>0?'+':'')+r+'%';}if(ct.dataIndex===labels.length-1)t+=' (í˜„ì¬)';return t;},title:function(items){return items[0].label;}}}},scales:{x:{ticks:{color:'#8b949e',font:{family:'JetBrains Mono',size:9},maxRotation:45,minRotation:25,maxTicksLimit:8},grid:{color:'rgba(30,45,61,0.3)'}},y:{ticks:{color:'#8b949e',font:{family:'JetBrains Mono',size:10}},grid:{color:'rgba(30,45,61,0.3)'}}}}});}

function renderTab6(){const f=document.getElementById('hist-filter').value;
let st=DATA.stocks.filter(s=>{const hp=s.histPerformance;if(!hp||!hp.similarCount||hp.similarCount<2)return false;if(f==='cheap')return s.pePercentile<=25;if(f==='expensive')return s.pePercentile>=75;return true;});
if(f==='cheap')st.sort((a,b)=>a.pePercentile-b.pePercentile);else if(f==='expensive')st.sort((a,b)=>b.pePercentile-a.pePercentile);else st.sort((a,b)=>Math.abs(b.pePercentile-50)-Math.abs(a.pePercentile-50));
st=st.slice(0,20);
let h='<div class="hist-grid">';
st.forEach(s=>{const hp=s.histPerformance;const ic=s.pePercentile<=30;const zc=ic?'sig-cheap':'sig-exp';const zt=ic?'P/E í•˜ìœ„ '+s.pePercentile+'%':'P/E ìƒìœ„ '+(100-s.pePercentile)+'%';const ac=hp.avg6mReturn>=0?'val-low':'val-high';const wc=hp.winRate>=60?'val-low':hp.winRate<=40?'val-high':'val-mid';
let ch='';if(hp.cases)hp.cases.slice(0,4).forEach(c=>{const rc=c.return6m>=0?'val-low':'val-high';ch+='<div class="hist-case"><span class="hist-case-date">'+c.date+'</span><span class="hist-case-pe">P/E '+fn(c.pe)+'</span><span class="hist-case-result '+rc+'">'+(c.return6m>0?'+':'')+fn(c.return6m)+'%</span></div>';});
h+='<div class="hist-card" data-ticker="'+s.ticker+'" onclick="selHistStock(\''+s.ticker+'\')"><div class="hist-card-header"><div><div class="hist-ticker">'+s.ticker+'</div><span class="sector-badge">'+ss(s.sector)+'</span></div><span class="hist-zone '+zc+'">í˜„ì¬ '+zt+'</span></div><div class="hist-stats"><div class="hist-stat"><div class="hist-stat-label">ìœ ì‚¬ êµ¬ê°„</div><div class="hist-stat-val" style="color:var(--blue)">'+hp.similarCount+'íšŒ</div></div><div class="hist-stat"><div class="hist-stat-label">6ê°œì›” í›„ í‰ê· </div><div class="hist-stat-val '+ac+'">'+(hp.avg6mReturn>0?'+':'')+fn(hp.avg6mReturn)+'%</div></div><div class="hist-stat"><div class="hist-stat-label">ìŠ¹ë¥ </div><div class="hist-stat-val '+wc+'">'+hp.winRate+'%</div></div></div>'+ch+'</div>';});
h+='</div><div class="legend" style="margin-top:14px"><div class="legend-item"><div class="legend-dot" style="background:var(--green)"></div>"ì €í‰ê°€" = P/E í•˜ìœ„ 25%</div><div class="legend-item"><div class="legend-dot" style="background:var(--red)"></div>"ê³ í‰ê°€" = P/E ìƒìœ„ 25%</div><div class="legend-item"><div class="legend-dot" style="background:var(--blue)"></div>6ê°œì›” í›„ ìˆ˜ìµë¥ </div></div>';
document.getElementById('tab6-content').innerHTML=h;}

loadData();
</script>
</body>
</html>
